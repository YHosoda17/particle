<script>
    // HTML要素の取得
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const hpElement = document.getElementById('hp');
    const timeLeftElement = document.getElementById('timeLeft');
    const startButton = document.getElementById('startButton');
    const titleDisplay = document.getElementById('titleDisplay'); 

    // ----------------------------------------------------
    // ゲーム変数と初期設定
    // ----------------------------------------------------
    let gameLoopId;
    let timerId;
    let score = 0;
    let isGameRunning = false;
    let timeLeft = 15;
    
    // プレイヤー設定
    const player = { x: 50, y: canvas.height / 2, width: 20, height: 20, speed: 5, color: 'blue', hp: 3, canShoot: false, isCoolingDown: false };

    // 配列管理
    let bullets = [];
    let enemies = [];
    
    // キー入力管理
    let keys = {};
    window.addEventListener('keydown', (e) => {
        keys[e.code] = true;
        // ゲーム実行中かつスペースキーが押されたら弾を撃つ
        if (isGameRunning && e.code === 'Space' && !player.isCoolingDown) {
            shootBullet();
        }
    });
    window.addEventListener('keyup', (e) => keys[e.code] = false);

    // 敵の出現間隔とカウンター
    let enemySpawnInterval = 120; // 120フレームに1回
    let spawnCounter = 0;

    // ----------------------------------------------------
    // 称号データ
    // ----------------------------------------------------
    const titles = [
        { score: 300, name: " 宇宙の支配者" },
        { score: 200, name: " 銀河の英雄" },
        { score: 150, name: " エースパイロット" },
        { score: 100, name: " 熟練シューター" },
        { score: 50, name: " 見習いガンナー" },
        { score: 0, name: "--- 未挑戦 ---" }
    ];

    // ----------------------------------------------------
    // 称号を更新する関数
    // ----------------------------------------------------
    function updateTitleDisplay(currentScore) {
        let bestTitle = titles[titles.length - 1]; 

        for (const title of titles) {
            if (currentScore >= title.score) {
                bestTitle = title;
                break;
            }
        }
        
        if (isGameRunning) {
             titleDisplay.textContent = `現在のスコア: ${currentScore}点`;
        } else if (currentScore > 0 && timeLeft <= 0) {
             titleDisplay.textContent = `称号: ${bestTitle.name}`;
        } else if (player.hp <= 0 && currentScore > 0) {
             titleDisplay.textContent = `称号: ${bestTitle.name} (スコア: ${currentScore}点)`;
        } else {
             titleDisplay.textContent = 'ゲームをスタートしてください';
        }
    }
    
    // ----------------------------------------------------
    // ゲーム制御関数
    // ----------------------------------------------------

    function resetGame() {
        // 変数を初期化
        score = 0;
        player.hp = 3;
        timeLeft = 15;
        player.x = 50;
        player.y = canvas.height / 2;
        bullets = [];
        enemies = [];
        keys = {};
        enemySpawnInterval = 120;
        spawnCounter = 0;

        // 表示をリセット
        scoreElement.textContent = score;
        hpElement.textContent = player.hp;
        timeLeftElement.textContent = timeLeft;
        
        // キャンバスをクリアし、待機メッセージを表示
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#e9c46a';
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('PRESS START', canvas.width / 2, canvas.height / 2);

        startButton.disabled = false;
        updateTitleDisplay(0);
    }

    function startGame() {
        if (isGameRunning) return;
        
        isGameRunning = true;
        startButton.disabled = true; 
        
        // カウントダウンタイマー開始
        timerId = setInterval(countdown, 1000);

        // ゲームループ開始
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    function countdown() {
        timeLeft--;
        timeLeftElement.textContent = timeLeft;

        if (timeLeft <= 0) {
            endGame('TIME UP! ');
        }
    }

    function endGame(message) {
        if (!isGameRunning) return;

        isGameRunning = false;
        clearInterval(timerId);
        cancelAnimationFrame(gameLoopId);
        
        updateTitleDisplay(score); 

        // ゲームオーバー画面表示
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ff0055';
        ctx.font = '40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = '24px Arial';
        ctx.fillStyle = '#e9c46a';
        ctx.fillText(`最終スコア: ${score}点`, canvas.width / 2, canvas.height / 2 + 30);

        // リセット
        setTimeout(resetGame, 3000); 
    }

    // ----------------------------------------------------
    // ゲーム要素関数 (変更なし)
    // ----------------------------------------------------

    function drawRect(obj) {
        ctx.fillStyle = obj.color;
        ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
    }
    
    function shootBullet() {
         bullets.push({
            x: player.x + player.width,
            y: player.y + player.height / 2 - 2,
            width: 10,
            height: 4,
            speed: 7,
            color: 'white'
        });
        
        player.isCoolingDown = true;
        setTimeout(() => { player.isCoolingDown = false; }, 150); 
    }

    function spawnEnemy() {
        spawnCounter++;
        if (spawnCounter >= enemySpawnInterval) {
            enemies.push({
                x: canvas.width,
                y: Math.random() * (canvas.height - 30) + 15,
                width: 30,
                height: 15,
                speed: Math.random() * 1.5 + 1.5,
                color: 'red'
            });

            spawnCounter = 0;
            if (enemySpawnInterval > 30) {
                enemySpawnInterval -= 2; 
            }
        }
    }
    
    function checkCollision(objA, objB) {
        return objA.x < objB.x + objB.width &&
               objA.x + objA.width > objB.x &&
               objA.y < objB.y + objB.height &&
               objA.y + objA.height > objB.y;
    }

    // ----------------------------------------------------
    // 更新ループ (変更なし)
    // ----------------------------------------------------

    function update() {
        // プレイヤーの移動
        if (keys['ArrowUp'] || keys['KeyW']) player.y = Math.max(0, player.y - player.speed);
        if (keys['ArrowDown'] || keys['KeyS']) player.y = Math.min(canvas.height - player.height, player.y + player.speed);
        if (keys['ArrowLeft'] || keys['KeyA']) player.x = Math.max(0, player.x - player.speed);
        if (keys['ArrowRight'] || keys['KeyD']) player.x = Math.min(canvas.width / 2 - player.width, player.x + player.speed);

        // 弾と敵の移動
        bullets.forEach(b => b.x += b.speed);
        enemies.forEach(e => e.x -= e.speed);

        // 衝突判定と要素のフィルタリング (前回のロジックを維持)
        enemies = enemies.filter(enemy => {
            if (checkCollision(player, enemy)) {
                player.hp--;
                hpElement.textContent = player.hp;
                return false; 
            }
            return enemy.x > -enemy.width; 
        });

        let newEnemies = [];
        let newBullets = [];
        
        enemies.forEach(enemy => {
            let hit = false;
            bullets.forEach(bullet => {
                if (checkCollision(bullet, enemy)) {
                    hit = true;
                    score += 10;
                    scoreElement.textContent = score;
                } else {
                    newBullets.push(bullet);
                }
            });

            if (!hit) {
                newEnemies.push(enemy);
            }
        });

        bullets = newBullets.filter(b => b.x < canvas.width);
        enemies = newEnemies;

        // HPチェック
        if (player.hp <= 0) {
            endGame('GAME OVER ');
        }
    }

    // ----------------------------------------------------
    // メインゲームループ
    // ----------------------------------------------------

    function gameLoop() {
        if (!isGameRunning) return; 

        // 1. 画面をクリア
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. 更新と生成
        update();
        spawnEnemy();

        // 3. 描画
        drawRect(player);
        bullets.forEach(drawRect);
        enemies.forEach(drawRect);

        // 4. 称号の更新と次のフレームを要求
        updateTitleDisplay(score);
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // ----------------------------------------------------
    // 初期化とリスナー設定
    // ----------------------------------------------------
    
    // イベントリスナーはHTMLで設定済みですが、念のため再確認
    startButton.addEventListener('click', startGame);
    
    // ページロード時にリセット状態にして待機
    resetGame(); 
</script>
